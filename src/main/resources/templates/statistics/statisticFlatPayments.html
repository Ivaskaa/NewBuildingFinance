<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Statistic flat payments</title>

    <style th:replace="blocks/linkAdminLTE"></style>
    <div th:replace="blocks/links"></div>
    <script th:src="@{/js/app.js}"></script>
    <link rel="stylesheet" th:href="@{/css/popup.css}">
</head>

<body class="sidebar-mini layout-fixed control-sidebar-slide-open" style="height: auto;">
<div class="wrapper">

    <div th:replace="blocks/navbar"></div>
    <div th:replace="blocks/sidebarContainer"></div>
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">

        <div class="content-header">
            <div class="container-fluid">
                <h1 class="m-0">Statistic flat payments</h1>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">

            <!-- Small boxes (Stat box) -->
            <div class="row">
                <div class="col">
                    <!-- small box -->
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3 th:text="${statistic.boxCountFlats}"></h3>

                            <p>Count flat</p>
                            <div class="row">
                                <div class="col">
                                    <p th:text="${statistic.boxCountFlatsSales} + ' Sales'"> </p>
                                </div>
                                <div class="col">
                                    <p th:text="${statistic.boxCountFlatsOnSale} + ' On sale'"></p>
                                </div>
                            </div>
                        </div>
                        <div class="icon">
                            <i class="ion ion-bag"></i>
                        </div>
                    </div>
                </div>
                <!-- ./col -->
                <div class="col">
                    <!-- small box -->
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3 th:text="${statistic.boxAllFlatSalePrice}"></h3>

                            <p>All flats price</p>
                            <div class="row">
                                <div class="col">
                                    <p th:text="${statistic.boxPlaned} + ' Planed'"></p>
                                </div>
                                <div class="col">
                                    <p th:text="${statistic.boxFact} + ' Fact'"></p>
                                </div>
                                <div class="col">
                                    <p th:text="${statistic.boxDuty} + ' Remains'"></p>
                                </div>
                            </div>
                        </div>
                        <div class="icon">
                            <i class="ion ion-stats-bars"></i>
                        </div>
                    </div>
                </div>
                <!-- ./col -->
                <div class="col">
                    <!-- small box -->
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3 th:text="${statistic.boxArrears}"></h3>

                            <p>Debt</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-pie-graph"></i>
                        </div>
                    </div>
                </div>
            </div>

            <table class="table">
                <thead>
                <tr>
                    <th scope="col">
                        <label>
                            <input id="flatNumber" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('number')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Flat</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="flatArea" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('area')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Area</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <select id="object" onchange="search()" class="form-control" style="width: 130px">
                                <option th:value="null" selected>Empty</option>
                                <option th:each="el : ${objects}" th:value="${el.id}" th:text="${el.house} + '(' + ${el.section} + ')'"></option>
                            </select>
                        </label>
                        <div onclick="sort('object')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Object</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="flatPriceStart" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <label>
                            <input id="flatPriceFin" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('price')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Price</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="flatSquarePriceStart" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <label>
                            <input id="flatSquarePriceFin" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('price')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Price per square meter</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="flatSalePriceStart" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <label>
                            <input id="flatSalePriceFin" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('salePrice')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Sale price</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="flatSaleSquarePriceStart" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <label>
                            <input id="flatSaleSquarePriceFin" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('salePrice')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Sale price per square meter</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="factStart" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <label>
                            <input id="factFin" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('fact')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Fact</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="remainsStart" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <label>
                            <input id="remainsFin" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('fact')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Remains</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="dutyStart" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <label>
                            <input id="dutyFin" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('duty')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Duty</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <select id="status" onchange="search()" class="form-control" style="width: 130px">
                                <option th:value="null" selected>Empty</option>
                                <option th:each="el : ${statuses}" th:value="${el.first}" th:text="${el.second}"></option>
                            </select>
                        </label>
                        <div onclick="sort('status')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Status</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="contractNumber" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('contract.number')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Contract number</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="buyer" oninput="search()" type="text" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('buyer.surname')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Buyer</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="phone" oninput="search()" type="text" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('buyer.phone')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Phone</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="email" oninput="search()" type="text" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('buyer.email')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Email</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="realtor" oninput="search()" type="text" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('realtor.surname')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Realtor</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <select id="agency" onchange="search()" class="form-control" style="width: 130px">
                                <option th:value="null" selected>Empty</option>
                                <option th:each="el : ${agencies}" th:value="${el.id}" th:text="${el.name}"></option>
                            </select>
                        </label>
                        <div onclick="sort('realtor.agency.name')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Agency</p>
                        </div>
                    </th>
                    <th scope="col">
                        <label>
                            <input id="sale" oninput="search()" type="number" min="1" max="10000000" class="form-control" style="width: 80px">
                        </label>
                        <div onclick="sort('price - salePrice')">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Sale</p>
                        </div>
                    </th>
                    <th scope="col">
                        <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Arrears</p>
                    </th>
                </tr>
                </thead>
                <tbody id="list">
                <!-- list -->
                </tbody>
            </table>
        </section>
    </div>
</div>

<div th:replace="blocks/scriptAdminLTE"></div>
<script th:src="@{/js/validation.js}"></script>

<script>
    let context = window.location.pathname.substring(0, window.location.pathname.indexOf("/",1));
    let url = window.location.protocol+"//"+ window.location.host + context;

    $(document).ready(function() {
        updatePage();
    });

    function updatePage(){
        let data = {
            objectId: $("#object").val(),
            dateStart: $("#periodStart").val(),
            dateFin: $("#periodEnd").val()
        }
        $.ajax({
            type: 'get',
            url: url + '/getPlanFactStatistics',
            data: data,
            dataType: "json",
            success: function (data){
                console.log('success /getPlanFactStatistics');
                updateList(data)
                updateAreaChart(data);
                updateSmallBoxes(data);
            },
            error: function() {
                console.log('error /getPlanFactStatistics');
            }
        });
    }

    function updateSmallBoxes(data){
        document.getElementById('countFlat').innerHTML = data.boxFlats;
        document.getElementById('countFlatSales').innerHTML = data.boxSalesFlats + " Sales";
        document.getElementById('countFlatLost').innerHTML = data.boxOnSaleFlats + " On sale";
        document.getElementById('flatsArea').innerHTML = roundPlus(data.boxArea, 2);
        document.getElementById('flatsAreaSales').innerHTML = roundPlus(data.boxSalesArea, 2) + " Sales";
        document.getElementById('flatsAreaLost').innerHTML = roundPlus(data.boxOnSaleArea, 2) + " On sale";
        document.getElementById('planed').innerHTML = roundPlus(data.boxPlaned, 2);
        document.getElementById('fact').innerHTML = roundPlus(data.boxFact, 2) + " Fact";
        document.getElementById('arrears').innerHTML = roundPlus(data.boxDuty, 2) + " Arrear";
    }

    function updateList(data) {
        $("#list").empty();
        console.log(data);
        data.tableDto.forEach((object) => {
            $("#list").append($("" +
                "<tr>" +
                "<td>" +
                "<p>" + moment(object.date).format('YYYY-MM') + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.planed + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.fact + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.duty + "</p>" +
                "</td>" +
                "</tr>"
            ));
        })
    }

    $("#datepicker").datepicker( {
        format: "mm-yyyy",
        viewMode: "months",
        minViewMode: "months"
    });
</script>

<div th:replace="blocks/scriptAdminLTE"></div>

</main>
</body>
</html>