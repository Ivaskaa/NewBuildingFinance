<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spending</title>

    <style th:replace="blocks/linkAdminLTE"></style>
    <div th:replace="blocks/links"></div>
    <script th:src="@{/js/app.js}"></script>
    <link rel="stylesheet" th:href="@{/css/popup.css}">
</head>

<body class="sidebar-mini layout-fixed control-sidebar-slide-open" style="height: auto;">
<div class="wrapper">

    <div th:replace="blocks/navbar"></div>
    <div th:replace="blocks/sidebarContainer"></div>
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">

        <div class="content-header">
            <div class="container-fluid">
                <h1 class="m-0">Spending</h1>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">

            <div class="row">
                <div class="col">
                    <div class="form-group mt-2">
                        <label>Article:</label>
                        <select id="article" onchange="articles(), uploadPrice()" class="form-control">
                        </select>
                        <p id='articleMessage' style="color: red"></p>
                    </div>
                    <div id="counterpartyDivRealtor" style="display: none">
                        <div class="form-group mt-2">
                            <label>Agency:</label>
                            <select id="agency" onchange="getRealtorsByAgencyId()" class="form-control">
                            </select>
                            <p id='agencyMessage' style="color: red"></p>
                        </div>
                        <div  class="form-group mt-2">
                            <label>Counterparty:</label>
                            <select id="counterpartyRealtor" class="form-control">
                                <option th:value="null" disabled selected>Choose realtor</option>
                            </select>
                            <p id='counterpartyRealtorMessage' style="color: red"></p>
                        </div>
                        <button onclick="openPopup()" class="btn btn-success popup-with-form">Create realtor</button>
                    </div>
                    <div id="counterpartyDivManager" class="form-group mt-2" style="display: none">
                        <label>Counterparty:</label>
                        <select id="counterpartyManager" class="form-control">
                        </select>
                        <p id='counterpartyManagerMessage' style="color: red"></p>
                    </div>
                    <div id="counterpartyDivDirector" class="form-group mt-2" style="display: none">
                        <label>Counterparty:</label>
                        <input id="counterpartyDirector" type="text" class="form-control" disabled>
                        <p id='counterpartyDirectorMessage' style="color: red"></p>
                    </div>
                    <div id="counterpartyDivString" class="form-group mt-2" style="display: none">
                        <label>Counterparty:</label>
                        <input id="counterpartyString" type="text" placeholder="Enter name surname counterparty" class="form-control">
                        <p id='counterpartyStringMessage' style="color: red"></p>
                    </div>
                    <div class="d-flex flex-nowrap mt-2">
                        <label class="m-1">Completed:</label>
                        <div class="form-check form-switch m-1">
                            <input id="completed" type="checkbox" class="form-check-input" role="switch">
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <div class="form-group mt-2">
                                <label>Number:</label>
                                <input id="number" type="number" placeholder="Enter number" class="form-control">
                                <p id='numberMessage' style="color: red"></p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group mt-2">
                                <label>Date:</label>
                                <input id="date" type="date" placeholder="Choose date" class="form-control">
                                <p id='dateMessage' style="color: red"></p>
                            </div>
                        </div>
                    </div>
                    <div id="forFlatPayment" style="display: none">
                        <div class="form-group mt-2">
                            <label>Object:</label>
                            <select id="object" onchange="getFlatsByObjectId()" class="form-control">
                            </select>
                            <p id='objectMessage' style="color: red"></p>
                        </div>
                        <div class="form-group mt-2">
                            <label>Flat number:</label>
                            <select id="flat" onchange="uploadPrice()" class="form-control">
                                <option th:value="null" disabled selected>Choose flat</option>
                            </select>
                            <p id='flatMessage' style="color: red"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                </div>
                <div class="col">
                </div>
                <div class="col">
                    <div class="form-group mt-2">
                        <label>Money:</label>
                        <input id="price" type="number" placeholder='Enter money' class="form-control" maxlength="15">
                        <p id='priceMessage' style="color: red"></p>
                    </div>
                    <div class="form-group mt-2">
                        <label>Currency:</label>
                        <select id="currency" onchange="uploadAdmissionCourse()" class="form-control">
                        </select>
                        <p id='currencyMessage' style="color: red"></p>
                    </div>
                    <div class="form-group mt-2">
                        <label>Admission course:</label>
                        <input id="admissionCourse" type="number" placeholder='Enter admission course' class="form-control" maxlength="5">
                        <p id='admissionCourseMessage' style="color: red"></p>
                    </div>
                </div>
            </div>
            <div class="form-group mt-2">
                <label>Comment:</label>
                <textarea id="comment" class="form-control" maxlength="5000"></textarea>
                <p id='commentMessage' style="color: red"></p>
            </div>

            <button id="saveButton" onclick="save()" class="btn btn-success popup-with-form">Save</button>
            <button id="deleteButton" onclick="deleteObject()" style="display: none" class="btn btn-danger popup-with-form">Delete</button>
            <a th:href="@{/cashRegister}" class="btn btn-dark popup-with-form">Back</a>
        </section>
    </div>
    <div id="popup" class="modal">
        <!-- popup -->
    </div>
</div>

<div th:replace="blocks/scriptAdminLTE"></div>
<script th:src="@{/js/validation.js}"></script>
<script src="https://unpkg.com/imask"></script>

<script>
    let SpendingId = "[[${cashRegisterId}]]";
    let FlatId = "[[${flatId}]]";
    let Spending = {};
    let Flat = {};
    let Realtor = {};


    let modal = document.getElementById("popup");
    let context = window.location.pathname.substring(0, window.location.pathname.indexOf("/",1));
    let url = window.location.protocol+"//"+ window.location.host + context;
    console.log(url)

    $(document).ready(function() {
        Spending.id = SpendingId;
        if(SpendingId != 0){
            getSpendingById();
        } else if (FlatId != 0){
            getFlatById();
        } else {
            getDirector();
            getAgencies();
            getManagers();
            getArticles();
            getObjects();
            getCurrencies();
        }
    })

    function articles(){
        if ($("#article").val() === 'COMMISSION_AGENCIES'){
            $("#forFlatPayment").show();
            $("#counterpartyDivManager").hide();
            $("#counterpartyDivString").hide();
            $("#counterpartyDivDirector").hide();
            $("#counterpartyDivRealtor").show();
        } else if($("#article").val() === 'COMMISSION_MANAGER'){
            $("#forFlatPayment").show();
            $("#counterpartyDivString").hide();
            $("#counterpartyDivRealtor").hide();
            $("#counterpartyDivDirector").hide();
            $("#counterpartyDivManager").show();
        } else if($("#article").val() === 'CONSTRUCTION_COSTS'){
            $("#forFlatPayment").hide();
            $("#counterpartyDivRealtor").hide();
            $("#counterpartyDivManager").hide();
            $("#counterpartyDivDirector").hide();
            $("#counterpartyDivString").show();
        } else if($("#article").val() === 'MONEY_FOR_DIRECTOR'){
            $("#forFlatPayment").hide();
            $("#counterpartyDivRealtor").hide();
            $("#counterpartyDivManager").hide();
            $("#counterpartyDivString").hide();
            $("#counterpartyDivDirector").show();
        }
    }

    function getSpendingById(){
        let data = {id: SpendingId};
        $.ajax({
            type: 'get',
            url: url + '/getSpendingById',
            dataType: "json",
            data: data,
            success: function (data) {
                console.log('success /getSpendingById');
                Spending = data;
                document.getElementById('admissionCourse').value = data.admissionCourse;
                document.getElementById('price').value = data.price;
                document.getElementById('date').value = moment(data.date).format('YYYY-MM-DD');
                document.getElementById('number').value = data.number;
                document.getElementById('completed').checked = data.completed;
                document.getElementById('comment').value = data.comment;
                document.getElementById('counterpartyString').value = data?.counterparty ?? '';

                getDirector();
                getAgencies();
                getManagers();
                getArticles();
                getObjects();
                getCurrencies();
            },
            error: function () {
                console.log('error /getSpendingById');
            }
        });
    }

    function getFlatById(){
        let data = {id: FlatId};
        $.ajax({
            type: 'get',
            url: url + '/getFlatById',
            dataType: "json",
            data: data,
            success: function (data) {
                console.log('success /getFlatById');
                Flat = data;
                $("#forFlatPayment").show();

                getDirector();
                getAgencies();
                getManagers();
                getArticles();
                getObjects();
                getCurrencies();
            },
            error: function () {
                console.log('error /getFlatById');
            }
        });
    }

    function save(){
        let spending = {};
        spending.number = document.getElementById('number').value;
        spending.date = document.getElementById('date').value;
        spending.status = document.getElementById('completed').checked;
        spending.objectId = $("#object").val();
        spending.flatId = $("#flat").val();
        spending.managerId = $("#counterpartyManager").val();
        spending.realtorId = $("#counterpartyRealtor").val();
        spending.counterparty = document.getElementById('counterpartyString').value;
        spending.article = $("#article").val();
        spending.price = document.getElementById('price').value;
        spending.currencyId = $("#currency").val();
        spending.admissionCourse = document.getElementById('admissionCourse').value;
        spending.comment = document.getElementById('comment').value;
        if (Spending.id == 0) {
            $.ajax({
                type: 'post',
                url: url + '/addSpending',
                data: JSON.stringify(spending),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('success /addSpending');
                    let validation = JSON.parse(data);
                    if (typeof validation !== 'object') {
                        window.location = '/cashRegister/spending/' + validation;
                    } else {
                        validationMessage(validation);
                    }
                },
                error: function () {
                    console.log('error /addSpending');
                }
            });
        } else {
            spending.id = Spending.id;
            $.ajax({
                type: 'post',
                url: url + '/updateSpending',
                data: JSON.stringify(spending),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('success /updateSpending');
                    let validation = JSON.parse(data);
                    if (validation == null) {
                        validationMessage(null);
                    } else {
                        validationMessage(validation);
                    }
                },
                error: function () {
                    console.log('error /updateSpending');
                }
            });
        }
    }

    function validationMessage(validation){
        if(validation === 1){
            document.getElementById('numberMessage').innerHTML = "";
            document.getElementById('number').style.border = "1px solid #ced4da";
            document.getElementById('dateMessage').innerHTML = "";
            document.getElementById('date').style.border = "1px solid #ced4da";
            document.getElementById('flatMessage').innerHTML = "";
            document.getElementById('flat').style.border = "1px solid #ced4da";
            document.getElementById('objectMessage').innerHTML = "";
            document.getElementById('object').style.border = "1px solid #ced4da";
            document.getElementById('counterpartyManagerMessage').innerHTML = "";
            document.getElementById('counterpartyManager').style.border = "1px solid #ced4da";
            document.getElementById('counterpartyRealtorMessage').innerHTML = "";
            document.getElementById('counterpartyRealtor').style.border = "1px solid #ced4da";
            document.getElementById('counterpartyStringMessage').innerHTML = "";
            document.getElementById('counterpartyString').style.border = "1px solid #ced4da";
            document.getElementById('counterpartyDirectorMessage').innerHTML = "";
            document.getElementById('counterpartyDirector').style.border = "1px solid #ced4da";
            document.getElementById('articleMessage').innerHTML = "";
            document.getElementById('article').style.border = "1px solid #ced4da";
            document.getElementById('priceMessage').innerHTML = "";
            document.getElementById('price').style.border = "1px solid #ced4da";
            document.getElementById('currencyMessage').innerHTML = "";
            document.getElementById('currency').style.border = "1px solid #ced4da";
            document.getElementById('admissionCourseMessage').innerHTML = "";
            document.getElementById('admissionCourse').style.border = "1px solid #ced4da";
            return;
        }
        if(validation?.number ?? false){
            document.getElementById('numberMessage').innerHTML = validation.number;
            document.getElementById('number').style.border = "1px solid red";
        }else {
            document.getElementById('numberMessage').innerHTML = "";
            document.getElementById('number').style.border = "1px solid green";
        }
        if(validation?.date ?? false){
            document.getElementById('dateMessage').innerHTML = validation.date;
            document.getElementById('date').style.border = "1px solid red";
        } else {
            document.getElementById('dateMessage').innerHTML = "";
            document.getElementById('date').style.border = "1px solid green";
        }
        if(validation?.flat ?? false){
            document.getElementById('flatMessage').innerHTML = validation.flat;
            document.getElementById('flat').style.border = "1px solid red";
        }else {
            document.getElementById('flatMessage').innerHTML = "";
            document.getElementById('flat').style.border = "1px solid green";
        }
        if(validation?.object ?? false){
            document.getElementById('objectMessage').innerHTML = validation.object;
            document.getElementById('object').style.border = "1px solid red";
        }else {
            document.getElementById('objectMessage').innerHTML = "";
            document.getElementById('object').style.border = "1px solid green";
        }
        if(validation?.manager ?? false){
            document.getElementById('counterpartyManagerMessage').innerHTML = validation.manager;
            document.getElementById('counterpartyManager').style.border = "1px solid red";
        } else {
            document.getElementById('counterpartyManagerMessage').innerHTML = "";
            document.getElementById('counterpartyManager').style.border = "1px solid green";
        }
        if(validation?.realtor ?? false){
            document.getElementById('counterpartyRealtorMessage').innerHTML = validation.realtor;
            document.getElementById('counterpartyRealtor').style.border = "1px solid red";
        } else {
            document.getElementById('counterpartyRealtorMessage').innerHTML = "";
            document.getElementById('counterpartyRealtor').style.border = "1px solid green";
        }
        if(validation?.counterparty ?? false){
            document.getElementById('counterpartyStringMessage').innerHTML = validation.counterparty;
            document.getElementById('counterpartyString').style.border = "1px solid red";
        } else {
            document.getElementById('counterpartyStringMessage').innerHTML = "";
            document.getElementById('counterpartyString').style.border = "1px solid green";
        }
        if(validation?.director ?? false){
            document.getElementById('counterpartyDirectorMessage').innerHTML = validation.director;
            document.getElementById('counterpartyDirector').style.border = "1px solid red";
        } else {
            document.getElementById('counterpartyDirectorMessage').innerHTML = "";
            document.getElementById('counterpartyDirector').style.border = "1px solid green";
        }
        if(validation?.article ?? false){
            document.getElementById('articleMessage').innerHTML = validation.article;
            document.getElementById('article').style.border = "1px solid red";
        } else {
            document.getElementById('articleMessage').innerHTML = "";
            document.getElementById('article').style.border = "1px solid green";
        }
        if(validation?.price ?? false){
            document.getElementById('priceMessage').innerHTML = validation.price;
            document.getElementById('price').style.border = "1px solid red";
        } else {
            document.getElementById('priceMessage').innerHTML = "";
            document.getElementById('price').style.border = "1px solid green";
        }
        if(validation?.currencyId ?? false){
            document.getElementById('currencyMessage').innerHTML = validation.currencyId;
            document.getElementById('currency').style.border = "1px solid red";
        }else {
            document.getElementById('currencyMessage').innerHTML = "";
            document.getElementById('currency').style.border = "1px solid green";
        }
        if(validation?.admissionCourse ?? false){
            document.getElementById('admissionCourseMessage').innerHTML = validation.admissionCourse;
            document.getElementById('admissionCourse').style.border = "1px solid red";
        }else {
            document.getElementById('admissionCourseMessage').innerHTML = "";
            document.getElementById('admissionCourse').style.border = "1px solid green";
        }
        setTimeout(function() {
            validationMessage(1)
        }, 3000);
    }

    function deleteObject(){
        let data = { id: Spending.id};
        $.ajax({
            type: 'post',
            url: url + '/deleteSpendingById',
            data: data,
            dataType: "json",
            success: function (data){
                console.log('success /deleteSpendingById');
                window.location = '/cashRegister';
            },
            error: function() {
                console.log('error /deleteSpendingById');
            }
        });
    }


    //upload info

    function uploadPrice() {
        let data = {id: $("#flat").val()};
        $.ajax({
            type: 'get',
            url: url + '/getFlatById',
            dataType: "json",
            data: data,
            success: function (data) {
                console.log('success /getFlatById');
                if ($("#article").val() === 'COMMISSION_AGENCIES'){
                    document.getElementById('price').value = data.salePrice / 100 * data.agency
                } else if($("#article").val() === 'COMMISSION_MANAGER'){
                    document.getElementById('price').value = data.salePrice / 100 * data.manager
                }
            },
            error: function () {
                console.log('error /getFlatById');
            }
        });
    }

    function uploadAdmissionCourse(){
        let data = {id: $("#currency").val()}
        $.ajax({
            type: 'get',
            url: url + '/getCurrencyById',
            dataType: "json",
            data: data,
            success: function (data) {
                console.log('success /getCurrencyById');
                document.getElementById('admissionCourse').value = data.price;
                document.getElementById('admissionCourse').disabled = data.name === 'UAH';
            },
            error: function () {
                console.log('error /getCurrencyById');
            }
        });
    }

    function getDirector(){
        let director = document.getElementById('counterpartyDirector');
        director.disabled = true;
        $.ajax({
            type: 'get',
            url: url + '/getDirector',
            dataType: "json",
            success: function (data) {
                console.log('success /getDirector');
                director.value = data.surname + ' ' + data.name;
            },
            error: function () {
                console.log('error /getDirector');
            }
        });
    }


    // selects

    function getArticles(){
        $.ajax({
            type: 'get',
            url: url + '/getArticlesForSpending',
            dataType: "json",
            success: function (data) {
                console.log('success /getArticlesForSpending');
                $("#article").append($("" +
                    "<option selected disabled value='" + null + "'>Choose article</option>"
                ));
                data.forEach((element) => {
                    if(element.first === Spending?.article ?? null){
                        $("#article").append($("" +
                            "<option selected value='" + element.first + "'> " + element.second + "</option>"
                        ));
                        articles();
                    } else {
                        $("#article").append($("" +
                            "<option value='" + element.first + "'> " + element.second + "</option>"
                        ));
                    }
                })
            },
            error: function () {
                console.log('error /getArticlesForSpending');
            }
        });
    }

    function getCurrencies(){
        $.ajax({
            type: 'get',
            url: url + '/getCurrencies',
            dataType: "json",
            success: function (data) {
                console.log('success /getCurrencies');
                $("#currency").append($("" +
                    "<option selected disabled value='" + null + "'>Choose currency</option>"
                ));
                data.forEach((element) => {
                    if(element.id === Spending?.currencyId ?? null){
                        $("#currency").append($("" +
                            "<option selected value='" + element.id + "'> " + element.name + " (" + element.price + ")</option>"
                        ));
                    } else {
                        $("#currency").append($("" +
                            "<option value='" + element.id + "'> " + element.name + " (" + element.price + ")</option>"
                        ));
                    }
                })
            },
            error: function () {
                console.log('error /getCurrencies');
            }
        });
    }

    function getManagers(){
        $("#counterpartyManager").empty();
        $("#counterpartyManager").append($("" +
            "<option selected disabled value='" + null + "'>Choose manager</option>"
        ));
        $.ajax({
            type: 'get',
            url: url + '/getManagers',
            dataType: "json",
            success: function (data) {
                console.log('success /getManagers');
                data.forEach((element) => {
                    if(element.id === Spending?.managerId ?? null){
                        $("#counterpartyManager").append($("" +
                            "<option selected value='" + element.id + "'> " + element.surname + " " + element.name + "</option>"
                        ));
                    } else {
                        $("#counterpartyManager").append($("" +
                            "<option value='" + element.id + "'> " + element.surname + " " + element.name + "</option>"
                        ));
                    }
                })
            },
            error: function () {
                console.log('error /getManagers');
            }
        });
    }

    function getAgencies(){
        $("#agency").empty();
        $("#agency").append($("" +
            "<option selected disabled value='" + null + "'>Choose agency</option>"
        ));
        $.ajax({
            type: 'get',
            url: url + '/getAgencies',
            dataType: "json",
            success: function (data) {
                console.log('success /getAgencies');
                data.forEach((element) => {
                    console.log(Realtor);
                    console.log(element.id);
                    if(element.id === Realtor?.agencyId ?? null){
                        $("#agency").append($("" +
                            "<option selected value='" + element.id + "'> " + element.name + "</option>"
                        ));
                        getRealtorsByAgencyId()
                    } else if(element.id === Spending?.agencyId ?? null){
                        $("#agency").append($("" +
                            "<option selected value='" + element.id + "'> " + element.name + "</option>"
                        ));
                        getRealtorsByAgencyId()
                    } else {
                        $("#agency").append($("" +
                            "<option value='" + element.id + "'> " + element.name + "</option>"
                        ));
                    }
                })
            },
            error: function () {
                console.log('error /getAgencies');
            }
        });
    }

    function getRealtorsByAgencyId(){
        let data = {id: $("#agency").val()};
        $("#counterpartyRealtor").empty();
        $("#counterpartyRealtor").append($("" +
            "<option selected disabled value='" + null + "'>Choose manager</option>"
        ));
        $.ajax({
            type: 'get',
            url: url + '/getRealtorsByAgencyId',
            dataType: "json",
            data: data,
            success: function (data) {
                console.log('success /getRealtorsByAgencyId');
                data.forEach((element) => {
                    if(element.id === Realtor?.id ?? null){
                        $("#counterpartyRealtor").append($("" +
                            "<option selected value='" + element.id + "'> " + element.surname + " " + element.name + "</option>"
                        ));
                    } else if(element.id === Spending?.realtorId ?? null){
                        $("#counterpartyRealtor").append($("" +
                            "<option selected value='" + element.id + "'> " + element.surname + " " + element.name + "</option>"
                        ));
                    } else {
                        $("#counterpartyRealtor").append($("" +
                            "<option value='" + element.id + "'> " + element.surname + " " + element.name + "</option>"
                        ));
                    }
                })
            },
            error: function () {
                console.log('error /getRealtorsByAgencyId');
            }
        });
    }

    function getObjects(){
        $.ajax({
            type: 'get',
            url: url + '/getObjects',
            dataType: "json",
            success: function (data) {
                console.log('success /getObjects');
                $("#object").empty();
                $("#object").append($("" +
                    "<option selected disabled value='" + null + "'>Choose object</option>"
                ));
                data.forEach((element) => {
                    if(element.id === Spending?.objectId ?? null){
                        $("#object").append($("" +
                            "<option selected value='" + element.id + "'> " + element.house + '(' + element.section + ')' + "</option>"
                        ));
                        getFlatsByObjectId();
                    } else if(element.id === Flat?.object?.id ?? null){
                        $("#object").append($("" +
                            "<option selected value='" + element.id + "'> " + element.house + '(' + element.section + ')' + "</option>"
                        ));
                        getFlatsByObjectId();
                    } else {
                        $("#object").append($("" +
                            "<option value='" + element.id + "'> " + element.house + '(' + element.section + ')' + "</option>"
                        ));
                    }
                })
            },
            error: function () {
                console.log('error /getObjects');
            }
        });
    }

    function getFlatsByObjectId(){
        let data = {
            id: $("#object").val(),
            flatId: Spending.flatId
        };
        $.ajax({
            type: 'get',
            url: url + '/getFlatsWithContractWithFlatPaymentsByObjectId',
            dataType: "json",
            data: data,
            success: function (data) {
                console.log('success /getFlatsWithContractWithFlatPaymentsByObjectId');
                $("#flat").empty();
                $("#flat").append($("" +
                    "<option selected disabled value='" + null + "'>Choose flat</option>"
                ));
                data.forEach((element) => {
                    if(element.id === Spending?.flatId ?? null){
                        $("#flat").append($("" +
                            "<option selected value='" + element.id + "'> " + element.number + "</option>"
                        ));
                        getFlatPaymentsByFlatId();
                    } else if (element.id === Flat?.id ?? null){
                        $("#flat").append($("" +
                            "<option selected value='" + element.id + "'> " + element.number + "</optionselected>"
                        ));
                        getFlatPaymentsByFlatId();
                    } else {
                        $("#flat").append($("" +
                            "<option value='" + element.id + "'> " + element.number + "</option>"
                        ));
                    }
                })
            },
            error: function () {
                console.log('error /getFlatsWithContractWithFlatPaymentsByObjectId');
            }
        });
    }

    // print to pdf

    function printToPdf(){
        if(Contract.id !== undefined) {
            window.location = url + "/getPdf/" + Contract.id;
        }
    }

    // realtor

    function saveRealtor(){
        let realtor = {};
        realtor.name = document.getElementById('realtorName').value;
        realtor.surname = document.getElementById('realtorSurname').value;
        realtor.phone = document.getElementById('realtorPhone').value;
        realtor.email = document.getElementById('realtorEmail').value;
        realtor.agencyId = $("#agencyRealtor").val();
        $.ajax({
            type: 'post',
            url: url + '/addRealtor',
            data: JSON.stringify(realtor),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                console.log('success /addRealtor');
                let validation = JSON.parse(data);
                if (typeof validation !== 'object') {
                    Realtor.id = parseInt(data);
                    Realtor.agencyId = parseInt($("#agencyRealtor").val());
                    console.log(Realtor);
                    closePopup();
                    getAgencies();
                } else {
                    validationMessageRealtor(validation);
                }
            },
            error: function () {
                console.log('error /addRealtor');
            }
        });
    }

    function openPopup(){
        modal.style.display = "block";
        $("#popup").append($(
            "<div class=\"modal-content\">\n" +
            "           <span onclick=\"closePopup()\" class=\"close\">&times;</span>\n" +
            "           <form class=\"mt-2\">\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Name:</label>\n" +
            "                   <input id=\"realtorName\" type=\"text\" maxlength=\"50\"\n" +
            "                           placeholder=\"Enter name\" class=\"form-control\">\n" +
            "                   <p id='realtorNameMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Surname:</label>\n" +
            "                   <input id=\"realtorSurname\" type=\"text\" maxlength=\"50\"\n" +
            "                              placeholder=\"Enter surname\" class=\"form-control\">\n" +
            "                   <p id='realtorSurnameMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Phone:</label>\n" +
            "                   <input id=\"realtorPhone\" type=\"text\" maxlength=\"20\"\n" +
            "                              placeholder=\"Enter phone\" class=\"form-control\">\n" +
            "                   <p id='realtorPhoneMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Agency:</label>\n" +
            "                   <select id=\"agencyRealtor\" class=\"form-control\">" +
            "                       <option selected disabled value=" + null + ">Choose agency</option>" +
            "                   </select>\n" +
            "                   <p id='agencyRealtorMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Email:</label>\n" +
            "                   <input id=\"realtorEmail\" type=\"text\" maxlength=\"20\"\n" +
            "                              placeholder=\"Enter email\" class=\"form-control\">\n" +
            "                   <p id='realtorEmailMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <button onclick=\"saveRealtor()\" type=\"button\" class=\"btn btn-success mt-2\">Save</button>\n" +
            "           </form>\n" +
            "       </div>"
        ));
        getAgenciesRealtor();
        mask();
    }

    function validationMessageRealtor(validation){
        if(validation?.name ?? false){
            document.getElementById('realtorNameMessage').innerHTML = validation.name;
            document.getElementById('realtorName').style.border = "1px solid red";
        }else {
            document.getElementById('realtorNameMessage').innerHTML = "";
            document.getElementById('realtorName').style.border = "1px solid green";
        }
        if(validation?.agencyId ?? false){
            document.getElementById('agencyRealtorMessage').innerHTML = validation.agencyId;
            document.getElementById('agencyRealtor').style.border = "1px solid red";
        }else {
            document.getElementById('agencyRealtorMessage').innerHTML = "";
            document.getElementById('agencyRealtor').style.border = "1px solid green";
        }
        if(validation?.surname ?? false){
            document.getElementById('realtorSurnameMessage').innerHTML = validation.surname;
            document.getElementById('realtorSurname').style.border = "1px solid red";
        }else {
            document.getElementById('realtorSurnameMessage').innerHTML = "";
            document.getElementById('realtorSurname').style.border = "1px solid green";
        }
        if(validation?.phone ?? false){
            document.getElementById('realtorPhoneMessage').innerHTML = validation.phone;
            document.getElementById('realtorPhone').style.border = "1px solid red";
        }else {
            document.getElementById('realtorPhoneMessage').innerHTML = "";
            document.getElementById('realtorPhone').style.border = "1px solid green";
        }
        if(validation?.email ?? false){
            document.getElementById('realtorEmailMessage').innerHTML = validation.email;
            document.getElementById('realtorEmail').style.border = "1px solid red";
        }else {
            document.getElementById('realtorEmailMessage').innerHTML = "";
            document.getElementById('realtorEmail').style.border = "1px solid green";
        }
    }

    function getAgenciesRealtor(){
        $("#agencyRealtor").empty();
        $("#agencyRealtor").append($("" +
            "<option selected disabled value='" + null + "'>Choose agency</option>"
        ));
        $.ajax({
            type: 'get',
            url: url + '/getAgencies',
            dataType: "json",
            success: function (data) {
                console.log('success /getAgencies');
                data.forEach((element) => {
                    if(element.id === $("#agency").val()){
                        $("#agencyRealtor").append($("" +
                            "<option selected value='" + element.id + "'> " + element.name + "</option>"
                        ));
                    } else {
                        $("#agencyRealtor").append($("" +
                            "<option value='" + element.id + "'> " + element.name + "</option>"
                        ));
                    }
                })
            },
            error: function () {
                console.log('error /getAgencies');
            }
        });
    }

    function closePopup(){
        modal.style.display = "none";
        $("#popup").empty();
    }

    function mask(){
        let element = document.getElementById('realtorPhone');
        let maskOptions = {
            mask: '+38(000)000-00-00',
            lazy: false
        }
        let mask = new IMask(element, maskOptions);
    }

</script>

</body>
</html>