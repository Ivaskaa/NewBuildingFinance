<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Agency</title>

    <style th:replace="blocks/linkAdminLTE"></style>
    <div th:replace="blocks/links"></div>
    <link rel="stylesheet" th:href="@{/css/tableSort.css}">
    <link rel="stylesheet" th:href="@{/css/popup.css}">
</head>

<body class="sidebar-mini layout-fixed control-sidebar-slide-open" style="height: auto;">
<div class="wrapper">

    <div th:replace="blocks/navbar"></div>
    <div th:replace="blocks/sidebarContainer"></div>
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">

        <div class="content-header">
            <div class="container-fluid">
                <h1 class="m-0">Agency</h1>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <button id="descriptionButton" onclick="changePage(this)" class="btn btn-dark">Description</button>
            <button id="salesButton" onclick="maybeSave(this)" class="btn btn-dark">Contracts</button>
            <button id="commissionsButton" onclick="maybeSave(this)" class="btn btn-dark">Commissions</button>
            <div id="descriptionPage">

                <div class="content-header">
                    <div class="container-fluid">
                        <h1 class="m-0">Description</h1>
                    </div>
                </div>

                <div class="form-group mt-2">
                    <label>Agency name:</label>
                    <input id="name" type="text" maxlength="50"
                           name="name" placeholder="Enter name" class="form-control">
                    <p id='nameMessage' style="color: red"></p>
                </div>
                <div class="form-group mt-2">
                    <label>Description:</label>
                    <textarea id="description" placeholder="Enter description" class="form-control"></textarea>
                </div>

                <div class="content-header">
                    <div class="container-fluid">
                        <h1 class="m-0">Realtors</h1>
                    </div>
                </div>

                <button id="realtorButton" onclick="maybeSave(this)" class="btn btn-success popup-with-form">Add realtor</button>
                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">
                            <div onclick="sortRealtor(this, 'name and surname')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Surname Name</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortRealtor(this, 'phone')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Phone</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortRealtor(this, 'email')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Email</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortRealtor(this, 'director')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Director</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Edit</p>
                        </th>
                        <th scope="col">
                            <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Delete</p>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="list">
                    <!-- list -->
                    </tbody>
                </table>

                <nav>
                    <ul id="choose-page" class="pagination">
                        <!-- pagination buttons -->
                    </ul>
                </nav>

                <button id="save" onclick="save(this)" class="btn btn-success popup-with-form">Save</button>
                <a th:href="@{/agencies/}" class="btn btn-dark popup-with-form">Back</a>
            </div>

            <div id="salesPage" style="display: none">
                <div class="content-header">
                    <div class="container-fluid">
                        <h1 class="m-0">Contracts</h1>
                    </div>
                </div>

                <label>
                    <select id="sizeSelectContract" style="width: 50px; " onchange="changeSizeContracts()" name='status' class='form-control'>
                        <option value=10 selected>10</option>
                        <option value=20>20</option>
                    </select>
                </label>

                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">
                            <div onclick="sortContracts(this, 'flat.number')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Flat number</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortContracts(this, 'flat.object')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Object</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortContracts(this, 'status')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Status</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortContracts(this, 'flatArea')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Area</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortContracts(this, 'price')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Price</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortContracts(this, 'buyer')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Buyer</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortContracts(this, 'id')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Contract number</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortContracts(this, 'date')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Date</p>
                                <div></div>
                            </div>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="listContracts">
                    <!-- list -->
                    </tbody>
                </table>
                <nav>
                    <ul id="choose-pageContracts" class="pagination">
                        <!-- pagination buttons -->
                    </ul>
                </nav>

            </div>

            <div id="commissionsPage" style="display: none">
                <div class="content-header">
                    <div class="container-fluid">
                        <h1 class="m-0">Commissions</h1>
                    </div>
                </div>

                <label>
                    <select id="sizeSelectCommissions" style="width: 50px; " onchange="changeSizeCommissions()" name='status' class='form-control'>
                        <option value=10 selected>10</option>
                        <option value=20>20</option>
                    </select>
                </label>

                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">
                            <div onclick="sortCommissions(this, 'flat.number')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Flat number</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortCommissions(this, 'flat.object')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Object</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortCommissions(this, 'flatArea')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Area</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortCommissions(this, 'price')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Price</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortCommissions(this, 'status')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Status</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortCommissions(this, 'flat.agency')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">%</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortCommissions(this, 'price')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Money</p>
                                <div></div>
                            </div>
                        </th>
                        <th scope="col">
                            <div onclick="sortCommissions(this, 'date')">
                                <p style="margin: 5px; display: inline-block; box-sizing: border-box;">Date</p>
                                <div></div>
                            </div>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="listCommissions">
                    <!-- list -->
                    </tbody>
                </table>
                <nav>
                    <ul id="choose-pageCommissions" class="pagination">
                        <!-- pagination buttons -->
                    </ul>
                </nav>
            </div>
        </section>
    </div>
    <div id="popup" class="modal">
        <!-- popup -->
    </div>
</div>

<script>
    let AgencyId = "[[${agencyId}]]";
    let Agency = {};
    let IdForUpdating;

    let UserId = "[[${userId}]]" ;

    let context = window.location.pathname.substring(0, window.location.pathname.indexOf("/", 1));
    let url = window.location.protocol + "//" + window.location.host + context;
    let modal = document.getElementById("popup");

    let currentPage = 1;
    let size = 10;
    let sortingField = 'id';
    let sortingDirection = 'ASC';  // DESC

    let totalPage;

    $(document).ready(function() {
        console.log('hello');
        getUserPermissions();
        Agency.id = AgencyId;
        if(AgencyId != 0){
            getAgencyById(AgencyId);
            updateRealtors();
        }
    });

    function changePage(element){
        if (element.id === 'descriptionButton'){
            $("#commissionsPage").hide();
            $("#salesPage").hide();
            $("#descriptionPage").show();
        }
        if (element.id === 'salesButton'){
            $("#descriptionPage").hide();
            $("#commissionsPage").hide();
            $("#salesPage").show();
        }
        if (element.id === 'commissionsButton'){
            $("#descriptionPage").hide();
            $("#salesPage").hide();
            $("#commissionsPage").show();
        }
    }

    function maybeSave(element){
        if(element.id === 'salesButton'){
            if(AgencyId == 0){
                save(element);
            } else {
                changePage(element);
            }
        }
        if(element.id === 'commissionsButton'){
            if(AgencyId == 0){
                save(element);
            } else {
                changePage(element);
            }
        }
        if(element.id === 'realtorButton'){
            if(AgencyId == 0){
                save(element);
            } else {
                openPopup("add");
            }
        }
        if(element.id === 'saveButton'){
            save(element);
        }
    }

    function sortRealtor(element, field){
        $("thead > tr > th > div > div").each(function(i, item){
            $(item).removeClass("triangle-desc triangle-asc");
        });
        let triangle = $(element).children('div');
        if(sortingDirection === 'ASC'){
            sortingDirection = 'DESC';
            $(triangle[0]).addClass("triangle-desc");
        } else {
            sortingDirection = 'ASC';
            $(triangle[0]).addClass("triangle-asc");
        }
        sortingField = field;
        updateRealtors();
    }

    function save(element){
        let agency = {};
        agency.name = document.getElementById('name').value;
        agency.description = document.getElementById('description').value;
        if (Agency.id == 0) {
            $.ajax({
                type: 'post',
                url: url + '/addAgency',
                data: JSON.stringify(agency),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('success /addAgency');
                    let validation = JSON.parse(data);
                    if(typeof validation !== "object"){
                        AgencyId = validation;
                        Agency.id = AgencyId;
                        console.log(AgencyId);
                        if(element.id === 'salesButton'){
                            changePage(element);
                        }
                        if(element.id === 'commissionsButton'){
                            changePage(element);
                        }
                        if(element.id === 'realtorButton'){
                            openPopup("add");
                        }
                        validationMessage(null);
                        success();
                    } else {
                        validationMessage(validation);
                    }
                },
                error: function () {
                    error();
                    console.log('error /addAgency');
                }
            });
        } else {
            agency.id = Agency.id;
            $.ajax({
                type: 'post',
                url: url + '/updateAgency',
                data: JSON.stringify(agency),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('success /updateAgency');
                    let validation = JSON.parse(data);
                    if (validation == null) {
                        validationMessage(null);
                        success();
                    } else {
                        validationMessage(validation);
                    }
                },
                error: function () {
                    error();
                    console.log('error /updateAgency');
                }
            });
        }
    }

    function validationMessage(validation){
        if(validation?.name ?? false){
            document.getElementById('nameMessage').innerHTML = validation.name;
            document.getElementById('name').style.border = "1px solid red";
        }else {
            document.getElementById('nameMessage').innerHTML = "";
            document.getElementById('name').style.border = "1px solid green";
        }
        setTimeout(function() {
            document.getElementById('nameMessage').innerHTML = "";
            document.getElementById('name').style.border = "1px solid #ced4da";
        }, 4000);
    }

    function validationMessageRealtor(validation){
        if(validation?.name ?? false){
            document.getElementById('realtorNameMessage').innerHTML = validation.name;
            document.getElementById('realtorName').style.border = "1px solid red";
        }else {
            document.getElementById('realtorNameMessage').innerHTML = "";
            document.getElementById('realtorName').style.border = "1px solid green";
        }
        if(validation?.surname ?? false){
            document.getElementById('realtorSurnameMessage').innerHTML = validation.surname;
            document.getElementById('realtorSurname').style.border = "1px solid red";
        }else {
            document.getElementById('realtorSurnameMessage').innerHTML = "";
            document.getElementById('realtorSurname').style.border = "1px solid green";
        }
        if(validation?.phone ?? false){
            document.getElementById('realtorPhoneMessage').innerHTML = validation.phone;
            document.getElementById('realtorPhone').style.border = "1px solid red";
        }else {
            document.getElementById('realtorPhoneMessage').innerHTML = "";
            document.getElementById('realtorPhone').style.border = "1px solid green";
        }
        if(validation?.email ?? false){
            document.getElementById('realtorEmailMessage').innerHTML = validation.email;
            document.getElementById('realtorEmail').style.border = "1px solid red";
        }else {
            document.getElementById('realtorEmailMessage').innerHTML = "";
            document.getElementById('realtorEmail').style.border = "1px solid green";
        }
        setTimeout(function() {
            document.getElementById('realtorNameMessage').innerHTML = "";
            document.getElementById('realtorName').style.border = "1px solid #ced4da";
            document.getElementById('realtorSurnameMessage').innerHTML = "";
            document.getElementById('realtorSurname').style.border = "1px solid #ced4da";
            document.getElementById('realtorPhoneMessage').innerHTML = "";
            document.getElementById('realtorPhone').style.border = "1px solid #ced4da";
            document.getElementById('realtorEmailMessage').innerHTML = "";
            document.getElementById('realtorEmail').style.border = "1px solid #ced4da";
        }, 4000);
    }

    function getAgencyById(){
        let data = { id: AgencyId };
        $.ajax({
            type: 'get',
            url: url +'/getAgencyById',
            data: data,
            dataType: "json",
            success: function (data){
                Agency = data;
                console.log('success /getAgencyById');
                document.getElementById('name').value = Agency.name;
                document.getElementById('description').value = Agency.description;
            },
            error: function() {
                console.log('error /getAgencyById');
            }
        });
    }

    function updateList(data) {
        $("#list").empty();
        data.content.forEach((object) => {
            $("#list").append($("" +
                "<tr>" +
                "<td>" +
                "<p>" + object.name + " " + object.surname + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.phone + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.email + "</p>" +
                "</td>" +
                "<td>" +
                "<c>" + object.director + "</c>" +
                "</td>" +
                "<td>" +
                "<button onclick='editForm(" + object.id + ")' class=\"btn btn-warning\" type=\"button\">Edit</button>" +
                "</td>" +
                "<td>" +
                "<button onclick='deleteObject(" + object.id + ")' class=\"btn btn-danger\" type=\"button\">Delete</button>" +
                "</td>" +
                "</tr>"
            ));
        })
        paginationButton();
    }

    function updateRealtors(){
        let data = {
            page: currentPage,
            size: size,
            field: sortingField,
            direction: sortingDirection,

            id: parseInt(AgencyId)
        }
        $.ajax({
            type: 'get',
            url: url + '/realtors/getRealtorsByAgencyId',
            data: data,
            dataType: "json",
            success: function (data){
                totalPage = data.totalPages;
                if(currentPage > totalPage && currentPage > 1){
                    currentPage = totalPage;
                    updateRealtors();
                }
                updateList(data)
                console.log('success /getRealtorsByAgencyId');
            },
            error: function() {
                console.log('error /getRealtorsByAgencyId');
            }
        });
    }

    function saveRealtor(style){
        let realtor = {};
        realtor.name = document.getElementById('realtorName').value;
        realtor.surname = document.getElementById('realtorSurname').value;
        realtor.phone = document.getElementById('realtorPhone').value;
        realtor.email = document.getElementById('realtorEmail').value;
        realtor.director = document.getElementById('realtorDirector').checked;
        realtor.agencyId = AgencyId;
        if (style === 'add') {
            $.ajax({
                type: 'post',
                url: url + '/realtors/addRealtor',
                data: JSON.stringify(realtor),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('success /addRealtor');
                    let validation = JSON.parse(data);
                    if (validation == null) {
                        closePopup();
                        updateRealtors();
                        success();
                    } else {
                        validationMessageRealtor(validation);
                    }
                },
                error: function () {
                    error();
                    console.log('error /addRealtor');
                }
            });
        }
        if (style === 'edit') {
            realtor.id = IdForUpdating;
            $.ajax({
                type: 'post',
                url: url + '/realtors/updateRealtor',
                data: JSON.stringify(realtor),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('success /updateRealtor');
                    let validation = JSON.parse(data);
                    if (validation == null) {
                        closePopup();
                        updateRealtors();
                        success();
                    } else {
                        validationMessageRealtor(validation);
                    }
                },
                error: function () {
                    error();
                    console.log('error /updateRealtor');
                }
            });
        }
    }

    function openPopup(style){
        modal.style.display = "block";
        $("#popup").append($(
            "<div class=\"modal-content\">\n" +
            "           <span onclick=\"closePopup()\" class=\"close\">&times;</span>\n" +
            "           <form class=\"mt-2\">\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Name:</label>\n" +
            "                   <input id=\"realtorName\" type=\"text\" maxlength=\"50\"\n" +
            "                           placeholder=\"Enter name\" class=\"form-control\">\n" +
            "                   <p id='realtorNameMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Surname:</label>\n" +
            "                   <input id=\"realtorSurname\" type=\"text\" maxlength=\"50\"\n" +
            "                              placeholder=\"Enter surname\" class=\"form-control\">\n" +
            "                   <p id='realtorSurnameMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Phone:</label>\n" +
            "                   <input id=\"realtorPhone\" type=\"text\" maxlength=\"20\"\n" +
            "                              placeholder=\"Enter phone\" class=\"form-control\">\n" +
            "                   <p id='realtorPhoneMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <div class=\"form-group mt-2\">\n" +
            "                   <label>Email:</label>\n" +
            "                   <input id=\"realtorEmail\" type=\"text\" maxlength=\"20\"\n" +
            "                              placeholder=\"Enter email\" class=\"form-control\">\n" +
            "                   <p id='realtorEmailMessage' style=\"color: red\"></p>" +
            "               </div>\n" +
            "               <div class=\"d-flex flex-nowrap mt-2\">\n" +
            "                   <label class=\"m-1\">Director:</label>\n" +
            "                   <div class=\"form-check form-switch m-1\">\n" +
            "                       <input id=\"realtorDirector\" type=\"checkbox\" class=\"form-check-input\" role=\"switch\">\n" +
            "                   </div>\n" +
            "               </div>\n" +
            "               <button onclick=\"saveRealtor('"  + style + "')\" type=\"button\" class=\"btn btn-success mt-2\">Save</button>\n" +
            "           </form>\n" +
            "       </div>"
        ));
        mask();
    }

    function closePopup(){
        modal.style.display = "none";
        $("#popup").empty();
    }

    function editForm(id){
        IdForUpdating = id;
        openPopup('edit');
        let data = { id: id };
        $.ajax({
            type: 'get',
            url: url + '/realtors/getRealtorById',
            data: data,
            dataType: "json",
            success: function (object){
                console.log('success /getRealtorById');
                document.getElementById('realtorName').value = object.name;
                document.getElementById('realtorSurname').value = object.surname;
                document.getElementById('realtorPhone').value = object.phone;
                document.getElementById('realtorEmail').value = object.email;
                document.getElementById('realtorDirector').checked = object.director;
            },
            error: function() {
                console.log('error /getRealtorById');
            }
        });
    }

    function deleteObject(id){
        deleteObjSecond(url, '/realtors/deleteRealtorById', id)
    }
    function afterDeleteObjSecond(){
        console.log('success /deleteRealtorById');
        updateRealtors();
    }

    function getUserPermissions(){
        let data = {id: UserId};
        $.ajax({
            type: 'get',
            url: url + '/getUserPermissionsById',
            data: data,
            dataType: "json",
            success: function (data){
                console.log('success /getUserPermissionsById');
                Permissions = data;
            },
            error: function() {
                console.log('error /getUserPermissionsById');
            }
        });
    }

    function paginationButton(){
        $("#choose-page").empty();
        if(totalPage > 1){
            if(currentPage !== 1){
                $("#choose-page").append($("" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goFirstPage()' style='height: 40px'>First</button>" +
                    "</div>" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goPreviousPage()' style='height: 40px'>\<\<</a>" +
                    "</div>"
                ));
            } else {
                $("#choose-page").append($("" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goFirstPage()' style='height: 40px'>First</button>" +
                    "</div>" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goPreviousPage()' style='height: 40px'>\<\<</a>" +
                    "</div>"
                ));
            }
            let start = currentPage - 2;
            let finish = currentPage + 2;
            for(let i = start; i <= finish; i++) {
                if(i > 0 && i <= totalPage) {
                    if (currentPage === i) {
                        $("#choose-page").append($("" +
                            "<div class='page-item active'>" +
                            "<button onclick='goToPage(" + i + ")' class='page-link' tabIndex=\"-1\" style='height: 40px; width: 40px'>" + i + "</button>" +
                            "</div>"
                        ));
                    } else {
                        $("#choose-page").append($("" +
                            "<div class='page-item'>" +
                            "<button onclick='goToPage(" + i + ")' class='page-link' tabIndex=\"-1\" style='height: 40px; width: 40px'>" + i + "</button>" +
                            "</div>"
                        ));
                    }
                }
            }
            if(currentPage !== totalPage) {
                $("#choose-page").append($("" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goNextPage()' style='height: 40px'>\>\></button>" +
                    "</div>" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goLastPage()' style='height: 40px'>Last</a>" +
                    "</div>"
                ));
            } else {
                $("#choose-page").append($("" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goNextPage()' style='height: 40px'>\>\></button>" +
                    "</div>" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goLastPage()' style='height: 40px'>Last</a>" +
                    "</div>"
                ));
            }
        }
    }

    function goFirstPage(){
        currentPage = 1;
        updateRealtors();
    }
    function goPreviousPage(){
        currentPage--;
        updateRealtors()
    }
    function goToPage(i){
        currentPage = i;
        updateRealtors()
    }
    function goNextPage(){
        currentPage++;
        updateRealtors()
    }
    function goLastPage(){
        currentPage = totalPage;
        updateRealtors()
    }


    // contrats

    let currentPageContracts = 1;
    let sizeContracts = $('#sizeSelectContract').val();
    let sortingFieldContracts = 'id';
    let sortingDirectionContracts = 'ASC';  // DESC
    let totalPageContracts;

    $(document).ready(function() {
        updateListContracts();
    });

    function sortContracts(element, field){
        $("thead > tr > th > div > div").each(function(i, item){
            $(item).removeClass("triangle-desc triangle-asc");
        });
        let triangle = $(element).children('div');
        if(sortingDirectionContracts === 'ASC'){
            sortingDirectionContracts = 'DESC';
            $(triangle[0]).addClass("triangle-desc");
        } else {
            sortingDirectionContracts = 'ASC';
            $(triangle[0]).addClass("triangle-asc");
        }
        sortingFieldContracts = field;
        updateListContracts();
    }

    function updateListContracts(){
        let data = {
            page: currentPageContracts,
            size: sizeContracts,
            field: sortingFieldContracts,
            direction: sortingDirectionContracts,
            agencyId: AgencyId
        }
        $.ajax({
            type: 'get',
            url: url + '/getContractsByAgencyId',
            data: data,
            dataType: "json",
            success: function (data){
                totalPageContracts = data.totalPages;
                if(currentPageContracts > totalPageContracts){
                    if (currentPageContracts !== 1) {
                        currentPageContracts--;
                        updateListContracts();
                    }
                }
                updateContracts(data)
                console.log('success /getContractsByAgencyId');
            },
            error: function() {
                console.log('error /getContractsByAgencyId');
            }
        });
    }

    function updateContracts(data) {
        $("#listContracts").empty();
        data.content.forEach((object) => {
            $("#listContracts").append($("" +
                "<tr>" +
                "<td>" +
                "<p onclick='goToFlat(" + object.flatId + ")'>" + object.flatNumber + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.object + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.status + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.flatArea + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.price + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.buyer + "</p>" +
                "</td>" +
                "<td>" +
                "<p onclick='goToContract(" + object.id + ")'>" + object.id + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + moment(object.date).format('YYYY-MM-DD') + "</p>" +
                "</td>" +
                "</tr>"
            ));
        })
        paginationButtonContracts();
    }

    function goToFlat(id){
        Permissions.forEach((permission)=>{
            if(permission === "FLATS"){
                window.location = "/flats/flat/" + id;
            }
        })
    }

    function goToContract(id){
        Permissions.forEach((permission)=>{
            if(permission === "CONTRACTS"){
                window.location = "/contracts/contract/" + id;
            }
        })
    }

    function changeSizeContracts(){
        sizeContracts = $('#sizeSelectContracts').val();
        currentPageContracts = 1;
        updateListContracts()
    }

    function paginationButtonContracts(){
        $("#choose-pageContracts").empty();
        if(totalPageContracts > 1){
            if(currentPageContracts !== 1){
                $("#choose-pageContracts").append($("" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goFirstPageContracts()' style='height: 40px'>First</button>" +
                    "</div>" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goPreviousPageContracts()' style='height: 40px'>\<\<</a>" +
                    "</div>"
                ));
            } else {
                $("#choose-pageContracts").append($("" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goFirstPageContracts()' style='height: 40px'>First</button>" +
                    "</div>" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goPreviousPageContracts()' style='height: 40px'>\<\<</a>" +
                    "</div>"
                ));
            }
            let start = currentPageContracts - 2;
            let finish = currentPageContracts + 2;
            for(let i = start; i <= finish; i++) {
                if(i > 0 && i <= totalPageContracts) {
                    if (currentPageContracts === i) {
                        $("#choose-pageContracts").append($("" +
                            "<div class='page-item active'>" +
                            "<button onclick='goToPageContracts(" + i + ")' class='page-link' tabIndex=\"-1\" style='height: 40px; width: 40px'>" + i + "</button>" +
                            "</div>"
                        ));
                    } else {
                        $("#choose-pageContracts").append($("" +
                            "<div class='page-item'>" +
                            "<button onclick='goToPageContracts(" + i + ")' class='page-link' tabIndex=\"-1\" style='height: 40px; width: 40px'>" + i + "</button>" +
                            "</div>"
                        ));
                    }
                }
            }
            if(currentPageContracts !== totalPageContracts) {
                $("#choose-pageContracts").append($("" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goNextPageContracts()' style='height: 40px'>\>\></button>" +
                    "</div>" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goLastPageContracts()' style='height: 40px'>Last</a>" +
                    "</div>"
                ));
            } else {
                $("#choose-pageContracts").append($("" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goNextPageContracts()' style='height: 40px'>\>\></button>" +
                    "</div>" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goLastPageContracts()' style='height: 40px'>Last</a>" +
                    "</div>"
                ));
            }
        }
    }

    function goFirstPageContracts(){
        currentPageContracts = 1;
        updateListContracts();
    }
    function goPreviousPageContracts(){
        currentPageContracts--;
        updateListContracts()
    }
    function goToPageContracts(i){
        currentPageContracts = i;
        updateListContracts()
    }
    function goNextPageContracts(){
        currentPageContracts++;
        updateListContracts()
    }
    function goLastPageContracts(){
        currentPageContracts = totalPageContracts;
        updateListContracts()
    }


    // commissions

    let currentPageCommissions = 1;
    let sizeCommissions = $('#sizeSelectCommissions').val();
    let sortingFieldCommissions = 'id';
    let sortingDirectionCommissions = 'ASC';  // DESC
    let totalPageCommissions;

    $(document).ready(function() {
        updateListCommissions();
    });

    function sortCommissions(element, field){
        $("thead > tr > th > div > div").each(function(i, item){
            $(item).removeClass("triangle-desc triangle-asc");
        });
        let triangle = $(element).children('div');
        if(sortingDirectionCommissions === 'ASC'){
            sortingDirectionCommissions = 'DESC';
            $(triangle[0]).addClass("triangle-desc");
        } else {
            sortingDirectionCommissions = 'ASC';
            $(triangle[0]).addClass("triangle-asc");
        }
        sortingFieldCommissions = field;
        updateListCommissions();
    }

    function updateListCommissions(){
        let data = {
            page: currentPageCommissions,
            size: sizeCommissions,
            field: sortingFieldCommissions,
            direction: sortingDirectionCommissions,
            agencyId: AgencyId
        }
        $.ajax({
            type: 'get',
            url: url + '/getCommissionsByAgencyId',
            data: data,
            dataType: "json",
            success: function (data){
                totalPageCommissions = data.totalPages;
                if(currentPageCommissions > totalPageCommissions){
                    if (currentPageCommissions !== 1) {
                        currentPageCommissions--;
                        updateListCommissions();
                    }
                }
                updateCommissions(data)
                console.log('success /getCommissionsByAgencyId');
            },
            error: function() {
                console.log('error /getCommissionsByAgencyId');
            }
        });
    }

    function updateCommissions(data) {
        $("#listCommissions").empty();
        data.content.forEach((object) => {
            $("#listCommissions").append($("" +
                "<tr>" +
                "<td>" +
                "<p onclick='goToFlat(" + object.flatId + ")'>" + object.flatNumber + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.object + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.flatArea + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.price + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.status + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.percent + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + object.money + "</p>" +
                "</td>" +
                "<td>" +
                "<p>" + moment(object.date).format('YYYY-MM-DD') + "</p>" +
                "</td>" +
                "</tr>"
            ));
        })
        paginationButtonCommissions();
    }

    function changeSizeCommissions(){
        sizeCommissions = $('#sizeSelectCommissions').val();
        currentPageCommissions = 1;
        updateListCommissions()
    }

    function paginationButtonCommissions(){
        $("#choose-pageCommissions").empty();
        if(totalPageCommissions > 1){
            if(currentPageCommissions !== 1){
                $("#choose-pageCommissions").append($("" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goFirstPageCommissions()' style='height: 40px'>First</button>" +
                    "</div>" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goPreviousPageCommissions()' style='height: 40px'>\<\<</a>" +
                    "</div>"
                ));
            } else {
                $("#choose-pageCommissions").append($("" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goFirstPageCommissions()' style='height: 40px'>First</button>" +
                    "</div>" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goPreviousPageCommissions()' style='height: 40px'>\<\<</a>" +
                    "</div>"
                ));
            }
            let start = currentPageCommissions - 2;
            let finish = currentPageCommissions + 2;
            for(let i = start; i <= finish; i++) {
                if(i > 0 && i <= totalPageCommissions) {
                    if (currentPageCommissions === i) {
                        $("#choose-pageCommissions").append($("" +
                            "<div class='page-item active'>" +
                            "<button onclick='goToPageCommissions(" + i + ")' class='page-link' tabIndex=\"-1\" style='height: 40px; width: 40px'>" + i + "</button>" +
                            "</div>"
                        ));
                    } else {
                        $("#choose-pageCommissions").append($("" +
                            "<div class='page-item'>" +
                            "<button onclick='goToPageCommissions(" + i + ")' class='page-link' tabIndex=\"-1\" style='height: 40px; width: 40px'>" + i + "</button>" +
                            "</div>"
                        ));
                    }
                }
            }
            if(currentPageCommissions !== totalPageCommissions) {
                $("#choose-pageCommissions").append($("" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goNextPageCommissions()' style='height: 40px'>\>\></button>" +
                    "</div>" +
                    "<div class='page-item'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goLastPageCommissions()' style='height: 40px'>Last</a>" +
                    "</div>"
                ));
            } else {
                $("#choose-pageCommissions").append($("" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goNextPageCommissions()' style='height: 40px'>\>\></button>" +
                    "</div>" +
                    "<div class='page-item disabled'>" +
                    "   <button class='page-link' tabIndex=\"-1\" onclick='goLastPageCommissions()' style='height: 40px'>Last</a>" +
                    "</div>"
                ));
            }
        }
    }

    function goFirstPageCommissions(){
        currentPageCommissions = 1;
        updateListCommissions();
    }
    function goPreviousPageCommissions(){
        currentPageCommissions--;
        updateListCommissions()
    }
    function goToPageCommissions(i){
        currentPageCommissions = i;
        updateListCommissions()
    }
    function goNextPageCommissions(){
        currentPageCommissions++;
        updateListCommissions()
    }
    function goLastPageCommissions(){
        currentPageCommissions = totalPageCommissions;
        updateListCommissions()
    }


    function mask(){
        let element = document.getElementById('realtorPhone');
        let maskOptions = {
            mask: '+38(000)000-00-00',
            lazy: false
        }
        let mask = new IMask(element, maskOptions);
    }
</script>

<script th:src="@{/js/app.js}"></script>
<div th:replace="blocks/scriptAdminLTE"></div>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://unpkg.com/imask"></script>

</body>
</html>